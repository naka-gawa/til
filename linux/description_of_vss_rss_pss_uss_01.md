# メモリ管理.1

# Overview
- メモリ管理サブシステムは OS の重要な部分の一つ
- 物理メモリだけでは足りない状況を打破するために 仮想メモリ が生まれた
  - 仮想メモリ = virtual memory
  - 仮想メモリはコンピュータのメモリを大きく見せること以外にも様々な機能を提供しているので列挙する

# 提供機能
- 巨大なアドレス空間
  - OSは、システム上に実際以上のメモリがあるかのように振る舞う
  - 仮想メモリはシステム上の物理メモリよりも大容量にできる
- メモリマッピング
  - メモリマッピングはイメージやデータファイルをプロセスのアドレス空間に map するために使用される
    - 物理メモリのアドレスはバラバラなので、これを管理しつつ、アプリケーションを開発するのは難しい
    - なので連番でのアドレスとして扱えるようにしたのが、仮想記憶
    - アプリケーション開発者はほしい量だけを要求するプログラミングをすればよく、ドコから払い出せばよいかは MMU が対処する
    - MMU は解放された物理アドレスをかき集め、連番の仮想記憶へ振り直し、アプリへ払い出す
      - MMU = Memory Management Unit
      - 昔は MMU が Memory Controler に存在し、CPUとメモリの間に挟まれていたが今は CPU に内蔵される
    - MMU は仮想メモリと物理メモリをマッピングするが、物理メモリのマッピング先がない場合は、HDD の Swap領域にマッピングすることも可能
      - これが swap
      - 物理メモリが不足して、アクセス頻度の少ないメモリ領域を HDD の swap 領域へ追いやることを `swap out`
      - 逆に必要となった領域が空いたので、swap out で追いやられたのを、また物理メモリへ戻すことを `swap in`
- 公正な物理メモリの割当
  - システム上で実行されている個々のプロセスはシステムの物理メモリ上に公正な持ち分を所持することができる
- 共有仮想メモリ
  - 仮想メモリはプロセスが個別のアドレス空間を持つようにしているが、複数のプロセスでメモリを share しなければならない場合もある
    - 例: bash のコマンドシェルを実行しているプロセスがシステム上に複数存在することがある
  - その場合、個別のプロセスが仮想アドレス空間を持つよりも、一つだけのコピーが存在し、bash を実行するすべてのプロセスでその仮想アドレス空間を共有するほうが効率が良い
  - shared memory と Inter Process Communication で利用される

# Reference
- https://linuxjf.osdn.jp/JFdocs/The-Linux-Kernel-4.html
- https://milestone-of-se.nesuke.com/sv-basic/architecture/virtual-memory-and-swap 
